name: Build 

on: [push, pull_request]

jobs:
  # Make Windows build
  windows_build:
    name: Build plugin on windows
    runs-on: Windows-latest

    steps:
      - uses: actions/checkout@v2

      # install Visual Studio 2022 Community
      - name: Install Visual Studio 2022
        uses: ilammy/msvc-dev-cmd@v1
        
        with:
          arch: x64

      #- name: Prepare Build Loris
      #  run: |
      #    Write-Output "Current Location is $($PWD.Path)"
      #    cd "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
      #    powershell  -NoExit -Command "Import-Module ./Common7/Tools/Microsoft.VisualStudio.DevShell.dll; Enter-VsDevShell d718e166 -SkipAutomaticLocation"
      #    cd ${{github.workspace}}
      #    python scripts/prepare_windows_build.py
      #    tree tmp/fftw3 /F

      - name: Build
        run: |
          cd vamp-plugin-sdk
          ./configure
          make
          make install
          cd ..
          make -f Makefile.mingw32
          ls

  build_linux:
    name: Build on linux
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Build
        run: |
          sudo apt install libboost-math-dev
          cd vamp-plugin-sdk
          ./configure --enable-programs=no
          make clean
          make sdkstatic -j`nproc`
          cd ..
          make -f Makefile.linux64 -j`nproc`
          ls -l
          ldd pyin.so

      - uses: actions/upload-artifact@v3
        with:
          path: ./pyin.so

  build_macos:
    name: Build on macos
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Build
        run: |
          brew install boost
          # brew install vamp-plugin-sdk
          cd vamp-plugin-sdk
          ./configure --enable-programs=no
          make clean
          make sdkstatic -j3
          cd ..
          make -f Makefile.osx
          ls -l
          otool -L pyin.dylib
          # ls -l /opt/homebrew/opt/vamp-plugin-sdk/lib


      - uses: actions/upload-artifact@v3
        with:
          path: ./pyin.dylib

